define("auth_sentry/login_modal",["jquery","core/ajax","core/str","core/modal_factory","core/notification","./webcam"],(function($,Ajax,str,ModalFactory,Notification,Webcam){return{async init(userid,successmessage,failedmessage,threshold,modelurl,nouser){await faceapi.nets.ssdMobilenetv1.loadFromUri(modelurl);let desc_webcam="",start_webcam="",submit_attendance="",try_again="",cancel="",warning="";var detectface=async function(input,croppedImage){console.log(input),console.log(croppedImage);const output=await faceapi.detectAllFaces(input);detections=output[0].box;let res=async function(imageRef,box,croppedImage){const regionsToExtract=[new faceapi.Rect(box.x,box.y,box.width,box.height)];let faceImages=await faceapi.extractFaces(imageRef,regionsToExtract);if(0!==faceImages.length)return faceImages.forEach((cnv=>{croppedImage.src=cnv.toDataURL()})),croppedImage.src;console.log("No face found")}(input,detections,croppedImage);return res};$(".action-modal").on("click",(function(){let st_img_url="",username=$("#username").val();console.log(username);let request={methodname:"auth_sentry_by_face_image_api",args:{username:username}};Ajax.call([request],!0,!1)[0].done((function(value){st_img_url=value.image_url,async function(){desc_webcam=await str.get_string("desc_webcam","auth_sentry"),start_webcam=await str.get_string("start_webcam","auth_sentry"),submit_attendance=await str.get_string("submit_attendance","auth_sentry"),try_again=await str.get_string("try_again","auth_sentry"),cancel=await str.get_string("cancel","auth_sentry"),warning=await str.get_string("warning_webcam","auth_sentry")}().then((()=>{console.log("Modal Messages are printed"),create_modal()}))})).fail(Notification.exception);let create_modal=()=>{ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:str.get_string("title_webcam","auth_sentry"),body:"\n                          <div>\n                          <p id='desc_webcam'> "+desc_webcam+"\n                          </p><p> "+warning+' </p>\n                          </div>\n                          <div id="error-message" class="alert alert-danger" style="display: none;">\n                            '.concat(nouser,'\n                          </div>\n                          <video id="webcam" autoplay playsinline width="300" height="225" style="display:none;margin:auto"></video>\n                          <canvas id="canvas" class="d-none" style="display:none;"></canvas>\n                          <img id="st-image" style="display: none;"/>\n                          <img id="st-image-cropped" style="display: none;"/>\n                          <img id="webcam-image" style="display: none;"/>\n                          <img id="webcam-image-cropped" style="display: none;"/>\n                          <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: center; padding: 0.75rem;">\n                            <button id=\'start-webcam\' class="btn btn-primary"> ')+start_webcam+'</button>\n                            <button id="submit-attendance" style="display:none;" class="btn btn-primary"> '+submit_attendance+'</button>\n                            <button id="try-again" style="display:none;" class="btn btn-primary"> '+try_again+' </button>\n                            <button id=\'stop-webcam\' class="btn btn-secondary" style="margin-left:5px;"> '+cancel+' </button>\n                          </div>\n                          <div id="message"></div>'}).then((function(modal){modal.show(),$(".modal-footer").hide();const webcamElement=document.getElementById("webcam"),canvasElement=document.getElementById("canvas");let studentimg=document.getElementById("st-image");studentimg.src=st_img_url;let st_img="",webcam=new Webcam(webcamElement,"user",canvasElement);$(".close").on("click",(function(){webcam.stop(),window.location.href=$(location).attr("href")}));let hideSubmitAttendance=()=>{document.getElementById("submit-attendance").style.display="none"},displayFailedMessage=()=>{hideSubmitAttendance(),document.getElementById("try-again").style.display="block",console.log("TRY AGAIN"),displayMessage(failedmessage,0)},displayMessage=(message,flag)=>{var spn=document.createElement("span");spn.textContent=message+".",spn.setAttribute("class",flag?"text-success":"text-danger"),document.getElementById("message").appendChild(spn)},submitAttendance=(st_img,image,username)=>{let request={methodname:"auth_sentry_by_face_recognition_api",args:{studentimg:st_img,webcampicture:image,username:username}};Ajax.call([request],!0,!1)[0].done((function(value){value.original_img_response,value.face_img_response;let distance=value.distance;if(window.console.log(distance),null!=distance&&distance<threshold){let today=new Date;webcam.stop(),hideSubmitAttendance(),displayMessage(successmessage,1),Notification.confirm(successmessage,"\n                                                 Date: ".concat(today.toLocaleDateString("en-UK"),"<br>\n                        "),"Continue","Cancel",(()=>window.location.href=$(location).attr("href")),(()=>window.location.href=$(location).attr("href")));let request={methodname:"auth_sentry_log_face_match",args:{username:username,token:Math.floor(1e6*Math.random()+1),distance:distance}};Ajax.call([request],!0,!1)[0].done((function(value){"success"===value.status?(console.log("Record inserted successfully"),window.location.href=M.cfg.wwwroot+"/auth/sentry/success.php?username="+value.username+"&token="+value.token):console.error("Failed to insert record:",value.message)})).fail((function(err){console.error(err)}))}else displayFailedMessage()})).fail((function(err){window.console.log(err)}))};$("#start-webcam").on("click",(function(){webcamElement.style.display="block",canvasElement.style.display="block",$("#start-webcam").hide(),webcam.start().then((result=>{document.getElementById("submit-attendance").style.display="block",$("#submit-attendance").on("click",(function(){if((()=>{const message=document.getElementById("message");for(;message.hasChildNodes();)message.removeChild(message.firstChild)})(),!username)return void $("#error-message").show();document.getElementById("submit-attendance").disabled=!0,document.getElementById("submit-attendance").innerText="",document.getElementById("submit-attendance").innerHTML="<div id='spinner' class='spinner-border spinner-border-sm' role='status'></div>",st_img||(st_img=(studentimg=>{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");return canvas.width=studentimg.width,canvas.height=studentimg.height,ctx.drawImage(studentimg,0,0),canvas.toDataURL("image/png")})(studentimg));let image=webcam.snap(),webcamimg=document.getElementById("webcam-image"),webcamimgcrop=document.getElementById("webcam-image-cropped"),studentimgcrop=document.getElementById("st-image-cropped");webcamimg.src=image,async function(){st_img=await detectface(webcamimg,webcamimgcrop),image=await detectface(studentimg,studentimgcrop)}().then((()=>{submitAttendance(st_img,image,username)}))})),$("#try-again").on("click",(function(){window.location.href=$(location).attr("href")}))})).catch((err=>{window.console.log(err)}))})),$("#stop-webcam").on("click",(function(){webcam.stop(),window.location.href=$(location).attr("href")}))}))}}))}}}));

//# sourceMappingURL=login_modal.min.js.map